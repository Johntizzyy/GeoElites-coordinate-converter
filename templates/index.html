<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Coordinate converter for WGS84, Minna Datum, and UTM coordinate systems. Convert between geographic coordinate systems with interactive map visualization."
    />
    <meta
      name="keywords"
      content="coordinate converter, WGS84, Minna Datum, UTM, geodetic conversion, surveying"
    />
    <title>GeoElites Coordinate Converter</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      /* GLOBAL RESET */
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f1f8e9;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* HEADER */
      header {
        background: linear-gradient(90deg, #66bb6a, #43a047);
        color: white;
        text-align: center;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      header h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      /* LAYOUT */
      .main-container {
        display: flex;
        flex: 1;
        padding: 20px;
        gap: 20px;
        overflow: hidden;
        position: relative;
      }

      /* LEFT PANEL */
      .converter-panel {
        width: 450px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 20;
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border-top: 4px solid #66bb6a;
      }
      .card h3 {
        margin-top: 0;
        font-size: 1.1rem;
        color: #2e7d32;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }

      /* INPUTS & BUTTONS */
      .input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .input-group {
        flex: 1;
        position: relative;
      }
      label {
        display: block;
        font-size: 0.8rem;
        color: #555;
        margin-bottom: 4px;
        font-weight: 500;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 0.9rem;
        transition: border-color 0.3s;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: #66bb6a;
        box-shadow: 0 0 0 2px rgba(102, 187, 106, 0.2);
      }
      input.error {
        border-color: #f44336;
      }
      .error-message {
        color: #f44336;
        font-size: 0.75rem;
        margin-top: 4px;
        display: none;
      }
      button {
        width: 100%;
        background-color: #66bb6a;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 5px;
        transition: background-color 0.3s, transform 0.1s;
        font-size: 0.9rem;
      }
      button:hover:not(:disabled) {
        background-color: #43a047;
      }
      button:active:not(:disabled) {
        transform: scale(0.98);
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .locate-btn {
        background-color: #ff9800;
        width: auto;
        font-size: 0.8rem;
        padding: 5px 15px;
        margin-bottom: 15px;
      }
      .locate-btn:hover:not(:disabled) {
        background-color: #f57c00;
      }
      .clear-btn {
        background-color: #757575;
        font-size: 0.8rem;
        padding: 6px 12px;
        width: auto;
        margin-top: 0;
      }
      .clear-btn:hover:not(:disabled) {
        background-color: #616161;
      }
      .button-row {
        display: flex;
        gap: 5px;
      }

      /* LOADING INDICATOR */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* RESULTS */
      .result-box {
        margin-top: 10px;
        padding: 12px;
        background-color: #e8f5e9;
        border-left: 4px solid #66bb6a;
        font-size: 0.9rem;
        display: none;
        border-radius: 4px;
      }
      .result-box.error {
        background-color: #ffebee;
        border-left-color: #f44336;
      }
      .result-item {
        margin: 8px 0;
        padding: 8px;
        background: white;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .result-label {
        font-weight: 600;
        color: #2e7d32;
      }
      .result-value {
        font-family: "Courier New", monospace;
        color: #333;
      }
      .copy-btn {
        background: #66bb6a;
        border: none;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        margin-left: 8px;
      }
      .copy-btn:hover {
        background: #43a047;
      }
      .copy-btn.copied {
        background: #4caf50;
      }

      /* RIGHT PANEL (MAP) */
      .map-panel {
        flex: 1;
        background: #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        min-height: 400px;
        z-index: 10;
      }
      #map {
        width: 100%;
        height: 100%;
        z-index: 1;
      }
      .map-error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        display: none;
      }

      /* FOOTER */
      footer {
        background-color: #1b5e20;
        color: white;
        text-align: center;
        padding: 10px;
        font-size: 0.8rem;
      }

      /* MOBILE */
      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
          height: auto;
          overflow: auto;
          padding: 10px;
          gap: 10px;
        }
        .converter-panel {
          width: 100%;
        }
        .map-panel {
          height: 400px;
          flex: none;
          min-height: 300px;
        }
        header h1 {
          font-size: 1.2rem;
        }
        .card {
          padding: 15px;
        }
      }
      @media (max-width: 480px) {
        .input-row {
          flex-direction: column;
        }
        .button-row {
          flex-direction: column;
        }
        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header><h1>GeoElites Coordinate Converter</h1></header>

    <div class="main-container">
      <div class="converter-panel">
        <div class="card">
          <h3>WGS84 &rarr; Minna / UTM</h3>
          <div style="display: flex; gap: 10px; margin-bottom: 10px">
            <button
              onclick="locateMe()"
              class="locate-btn"
              id="locate_btn"
              aria-label="Use GPS location"
            >
              <i class="fas fa-crosshairs"></i> Use My GPS Location
            </button>
            <button
              onclick="clearInputs('wgs')"
              class="clear-btn"
              aria-label="Clear inputs"
            >
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
          <div class="input-row">
            <div class="input-group">
              <label for="wgs_lat">Latitude (Dec or DMS)</label>
              <input
                type="text"
                id="wgs_lat"
                placeholder="e.g. 8 30 15 or 8.5"
                aria-label="WGS84 Latitude"
                aria-required="true"
              />
              <div class="error-message" id="wgs_lat_error"></div>
            </div>
            <div class="input-group">
              <label for="wgs_lon">Longitude (Dec or DMS)</label>
              <input
                type="text"
                id="wgs_lon"
                placeholder="e.g. 4 30 15 or 4.5"
                aria-label="WGS84 Longitude"
                aria-required="true"
              />
              <div class="error-message" id="wgs_lon_error"></div>
            </div>
          </div>
          <div class="button-row">
            <button
              onclick="convert('wgs_to_minna')"
              id="btn_wgs_to_minna"
              aria-label="Convert to Minna"
            >
              To Minna
            </button>
            <button
              onclick="convert('wgs_to_utm')"
              id="btn_wgs_to_utm"
              aria-label="Convert to UTM"
            >
              To UTM
            </button>
          </div>
          <div
            id="res_wgs"
            class="result-box"
            role="region"
            aria-live="polite"
            aria-label="Conversion results"
          ></div>
        </div>

        <div class="card">
          <h3>Minna (Geographic) &rarr; WGS84 / UTM</h3>
          <button
            onclick="clearInputs('minna')"
            class="clear-btn"
            style="margin-bottom: 10px"
            aria-label="Clear inputs"
          >
            <i class="fas fa-times"></i> Clear
          </button>
          <div class="input-row">
            <div class="input-group">
              <label for="minna_lat">Latitude (Minna)</label>
              <input
                type="text"
                id="minna_lat"
                placeholder="e.g. 8 30 15"
                aria-label="Minna Latitude"
                aria-required="true"
              />
              <div class="error-message" id="minna_lat_error"></div>
            </div>
            <div class="input-group">
              <label for="minna_lon">Longitude (Minna)</label>
              <input
                type="text"
                id="minna_lon"
                placeholder="e.g. 4 30 15"
                aria-label="Minna Longitude"
                aria-required="true"
              />
              <div class="error-message" id="minna_lon_error"></div>
            </div>
          </div>
          <div class="button-row">
            <button
              onclick="convert('minna_to_wgs')"
              id="btn_minna_to_wgs"
              aria-label="Convert to WGS84"
            >
              To WGS84
            </button>
            <button
              onclick="convert('minna_to_utm')"
              id="btn_minna_to_utm"
              aria-label="Convert to Minna UTM"
            >
              To Minna UTM
            </button>
          </div>
          <div
            id="res_minna"
            class="result-box"
            role="region"
            aria-live="polite"
            aria-label="Conversion results"
          ></div>
        </div>

        <div class="card">
          <h3>Minna (UTM) &rarr; WGS84</h3>
          <button
            onclick="clearInputs('utm')"
            class="clear-btn"
            style="margin-bottom: 10px"
            aria-label="Clear inputs"
          >
            <i class="fas fa-times"></i> Clear
          </button>
          <div class="input-row">
            <div class="input-group">
              <label for="utm_e">Easting (m)</label>
              <input
                type="text"
                id="utm_e"
                placeholder="e.g. 500000"
                aria-label="UTM Easting"
                aria-required="true"
              />
              <div class="error-message" id="utm_e_error"></div>
            </div>
            <div class="input-group">
              <label for="utm_n">Northing (m)</label>
              <input
                type="text"
                id="utm_n"
                placeholder="e.g. 900000"
                aria-label="UTM Northing"
                aria-required="true"
              />
              <div class="error-message" id="utm_n_error"></div>
            </div>
          </div>
          <div class="input-row">
            <div class="input-group">
              <label for="utm_z">Zone (Required)</label>
              <select id="utm_z" aria-label="UTM Zone" aria-required="true">
                <option value="" selected disabled>-- Select Zone --</option>
                <option value="31">Zone 31</option>
                <option value="32">Zone 32</option>
                <option value="33">Zone 33</option>
              </select>
              <div class="error-message" id="utm_z_error"></div>
            </div>
          </div>
          <button
            onclick="convert('utm_to_wgs')"
            id="btn_utm_to_wgs"
            aria-label="Convert to WGS84"
          >
            Convert to WGS84
          </button>
          <div
            id="res_utm"
            class="result-box"
            role="region"
            aria-live="polite"
            aria-label="Conversion results"
          ></div>
        </div>
      </div>

      <div class="map-panel">
        <div id="map"></div>
        <div class="map-error" id="map_error">
          <p><strong>Map Loading Error</strong></p>
          <p>Unable to load map. Please check your internet connection.</p>
        </div>
      </div>
    </div>

    <footer>
      &copy; Department of Surveying and Geoinformatics, University of Ilorin
    </footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
      // --- GLOBAL VARIABLES ---
      var map = null;
      var marker = null;
      var accuracyCircle = null;
      var activeButtons = new Set();

      // --- INITIALIZE MAP ---
      function initMap() {
        try {
          map = L.map("map", {
            zoomControl: false,
            center: [8.482, 4.675],
            zoom: 13,
          });

          // --- BASEMAPS ---
          var osm = L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            {
              maxZoom: 19,
              attribution: "© OpenStreetMap",
              errorTileUrl:
                "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
            }
          ).addTo(map);

          var sat = L.tileLayer(
            "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
            {
              maxZoom: 19,
              attribution: "Tiles © Esri",
              errorTileUrl:
                "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
            }
          );

          L.control.layers({ "Street Map": osm, Satellite: sat }).addTo(map);

          // --- CONTROLS ---
          L.control.zoom({ position: "topright" }).addTo(map);
          L.control
            .scale({ position: "bottomright", metric: true, imperial: false })
            .addTo(map);

          document.getElementById("map_error").style.display = "none";
        } catch (e) {
          console.error("Map initialization error:", e);
          document.getElementById("map_error").style.display = "block";
        }
      }

      // Initialize map on load
      if (typeof L !== "undefined") {
        initMap();
      } else {
        document.getElementById("map_error").style.display = "block";
      }

      // --- VALIDATION FUNCTIONS ---
      function validateCoordinate(value, isLat) {
        if (!value || value.trim() === "") {
          return { valid: false, error: "This field is required" };
        }

        // Try to parse as DMS or decimal
        var parts = value
          .trim()
          .replace(/[°'"]/g, " ")
          .split(/\s+/)
          .filter((p) => p);

        if (parts.length === 0) {
          return { valid: false, error: "Invalid format" };
        }

        var num = parseFloat(parts[0]);
        if (isNaN(num)) {
          return { valid: false, error: "Invalid number format" };
        }

        // Check bounds
        if (isLat && (num < -90 || num > 90)) {
          return { valid: false, error: "Latitude must be between -90 and 90" };
        }
        if (!isLat && (num < -180 || num > 180)) {
          return {
            valid: false,
            error: "Longitude must be between -180 and 180",
          };
        }

        return { valid: true, error: "" };
      }

      function validateUTM(easting, northing) {
        var e = parseFloat(easting);
        var n = parseFloat(northing);

        if (isNaN(e) || isNaN(n)) {
          return {
            valid: false,
            error: "Easting and Northing must be valid numbers",
          };
        }

        if (e < 0 || e > 1000000) {
          return {
            valid: false,
            error: "Easting should be between 0 and 1,000,000m",
          };
        }

        if (n < 0 || n > 10000000) {
          return {
            valid: false,
            error: "Northing should be between 0 and 10,000,000m",
          };
        }

        return { valid: true, error: "" };
      }

      function showError(inputId, errorId, message) {
        var input = document.getElementById(inputId);
        var errorEl = document.getElementById(errorId);
        input.classList.add("error");
        errorEl.textContent = message;
        errorEl.style.display = "block";
      }

      function clearError(inputId, errorId) {
        var input = document.getElementById(inputId);
        var errorEl = document.getElementById(errorId);
        input.classList.remove("error");
        errorEl.style.display = "none";
      }

      function clearAllErrors() {
        var errors = document.querySelectorAll(".error-message");
        var inputs = document.querySelectorAll("input.error, select.error");
        errors.forEach((el) => (el.style.display = "none"));
        inputs.forEach((el) => el.classList.remove("error"));
      }

      // --- CLEAR INPUTS ---
      function clearInputs(type) {
        if (type === "wgs") {
          document.getElementById("wgs_lat").value = "";
          document.getElementById("wgs_lon").value = "";
          document.getElementById("res_wgs").style.display = "none";
          clearError("wgs_lat", "wgs_lat_error");
          clearError("wgs_lon", "wgs_lon_error");
        } else if (type === "minna") {
          document.getElementById("minna_lat").value = "";
          document.getElementById("minna_lon").value = "";
          document.getElementById("res_minna").style.display = "none";
          clearError("minna_lat", "minna_lat_error");
          clearError("minna_lon", "minna_lon_error");
        } else if (type === "utm") {
          document.getElementById("utm_e").value = "";
          document.getElementById("utm_n").value = "";
          document.getElementById("utm_z").value = "";
          document.getElementById("res_utm").style.display = "none";
          clearError("utm_e", "utm_e_error");
          clearError("utm_n", "utm_n_error");
          clearError("utm_z", "utm_z_error");
        }
        if (marker && map) {
          map.removeLayer(marker);
          marker = null;
        }
        if (accuracyCircle && map) {
          map.removeLayer(accuracyCircle);
          accuracyCircle = null;
        }
      }

      // --- LOADING STATE ---
      function setLoading(buttonId, isLoading) {
        var btn = document.getElementById(buttonId);
        if (!btn) return;

        if (isLoading) {
          // Store original HTML if not already stored
          if (!btn.hasAttribute("data-original-html-loading")) {
            btn.setAttribute("data-original-html-loading", btn.innerHTML);
          }
          btn.disabled = true;
          var originalText = btn.getAttribute("data-original-html-loading");
          // Extract text content from original HTML
          var tempDiv = document.createElement("div");
          tempDiv.innerHTML = originalText;
          var textContent = tempDiv.textContent || tempDiv.innerText || "";
          btn.innerHTML = '<span class="loading"></span>' + textContent.trim();
          activeButtons.add(buttonId);
        } else {
          btn.disabled = false;
          // Restore original HTML
          var originalHTML = btn.getAttribute("data-original-html-loading");
          if (originalHTML) {
            btn.innerHTML = originalHTML;
          } else {
            // Fallback: remove loading spinner if original not stored
            btn.innerHTML = btn.innerHTML.replace(
              /<span class="loading"><\/span>\s*/,
              ""
            );
          }
          activeButtons.delete(buttonId);
        }
      }

      // --- HELPER FUNCTIONS ---
      function escapeHtml(text) {
        var div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Get result container ID based on conversion type
      function getResultId(type) {
        if (type === "utm_to_wgs") {
          return "res_utm";
        } else if (type.startsWith("wgs")) {
          return "res_wgs";
        } else if (type.includes("minna")) {
          return "res_minna";
        }
        return "res_utm";
      }

      // Format error message consistently
      function formatErrorMessage(message) {
        return "<strong>Error:</strong> " + message;
      }

      // Validate Minna coordinates (used by multiple conversion types)
      function validateMinnaCoordinates(latId, lonId, latErrorId, lonErrorId) {
        var lat = document.getElementById(latId).value.trim();
        var lon = document.getElementById(lonId).value.trim();
        var isValid = true;

        var latVal = validateCoordinate(lat, true);
        var lonVal = validateCoordinate(lon, false);

        if (!latVal.valid) {
          showError(latId, latErrorId, latVal.error);
          isValid = false;
        }
        if (!lonVal.valid) {
          showError(lonId, lonErrorId, lonVal.error);
          isValid = false;
        }

        return { valid: isValid, lat: lat, lon: lon };
      }

      // Parse coordinate string (handles both decimal and DMS)
      function parseCoordinateString(coordStr) {
        var str = coordStr.trim();
        var num = parseFloat(str);

        if (!isNaN(num)) {
          return num;
        }

        // Try DMS parsing
        var parts = str
          .replace(/[°'"]/g, " ")
          .split(/\s+/)
          .filter((p) => p);
        if (parts.length >= 1) {
          return parseFloat(parts[0]);
        }

        return NaN;
      }

      // Create result item HTML with copy button
      function createResultItem(label, value, copyText) {
        return (
          '<div class="result-item">' +
          '<span class="result-label">' +
          escapeHtml(label) +
          ":</span>" +
          '<span class="result-value">' +
          escapeHtml(value) +
          "</span>" +
          '<button class="copy-btn" data-copy-text="' +
          escapeHtml(copyText) +
          '"><i class="fas fa-copy"></i></button>' +
          "</div>"
        );
      }

      // Update copy button after successful copy
      function updateCopyButton(button, originalHTML) {
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.add("copied");
        setTimeout(function () {
          button.innerHTML = originalHTML;
          button.classList.remove("copied");
        }, 2000);
      }

      // --- RESULT DISPLAY ---
      function showResult(id, html, isError) {
        var el = document.getElementById(id);
        el.innerHTML = html;
        el.className = "result-box" + (isError ? " error" : "");
        el.style.display = "block";

        // Attach event listeners to copy buttons after HTML is inserted
        var copyButtons = el.querySelectorAll(".copy-btn");
        copyButtons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            var textToCopy = btn.getAttribute("data-copy-text");
            copyToClipboard(textToCopy, btn);
          });
        });
      }

      function formatResult(data, type) {
        var html = "";

        if (type === "wgs_to_minna") {
          // Ensure lat and lon are numbers
          var lat =
            typeof data.lat === "number" ? data.lat : parseFloat(data.lat);
          var lon =
            typeof data.lon === "number" ? data.lon : parseFloat(data.lon);
          var latDms = data.lat_dms || "";
          var lonDms = data.lon_dms || "";

          if (isNaN(lat) || isNaN(lon)) {
            return '<div class="result-item"><span class="result-label">Error:</span><span class="result-value">Invalid coordinate data received</span></div>';
          }

          html = createResultItem("Minna Latitude", latDms, latDms);
          html += createResultItem("Decimal", lat.toFixed(8), lat.toFixed(8));
          html += createResultItem("Minna Longitude", lonDms, lonDms);
          html += createResultItem("Decimal", lon.toFixed(8), lon.toFixed(8));
        } else if (type === "wgs_to_utm") {
          // Ensure easting and northing are numbers
          var easting =
            typeof data.easting === "number"
              ? data.easting
              : parseFloat(data.easting);
          var northing =
            typeof data.northing === "number"
              ? data.northing
              : parseFloat(data.northing);
          var zone = data.zone || "";

          if (isNaN(easting) || isNaN(northing)) {
            return '<div class="result-item"><span class="result-label">Error:</span><span class="result-value">Invalid UTM data received</span></div>';
          }

          html =
            '<div class="result-item">' +
            '<span class="result-label">Zone:</span>' +
            '<span class="result-value">' +
            escapeHtml(String(zone)) +
            "</span>" +
            "</div>";
          html += createResultItem(
            "Easting",
            easting.toFixed(3) + " m",
            easting.toFixed(3)
          );
          html += createResultItem(
            "Northing",
            northing.toFixed(3) + " m",
            northing.toFixed(3)
          );
        } else if (type === "minna_to_wgs" || type === "utm_to_wgs") {
          // Ensure lat and lon are numbers
          var lat =
            typeof data.lat === "number" ? data.lat : parseFloat(data.lat);
          var lon =
            typeof data.lon === "number" ? data.lon : parseFloat(data.lon);
          var latDms = data.lat_dms || "";
          var lonDms = data.lon_dms || "";

          if (isNaN(lat) || isNaN(lon)) {
            return '<div class="result-item"><span class="result-label">Error:</span><span class="result-value">Invalid coordinate data received</span></div>';
          }

          html = createResultItem("WGS84 Latitude", latDms, latDms);
          html += createResultItem("Decimal", lat.toFixed(8), lat.toFixed(8));
          html += createResultItem("WGS84 Longitude", lonDms, lonDms);
          html += createResultItem("Decimal", lon.toFixed(8), lon.toFixed(8));
        } else if (type === "minna_to_utm") {
          // Ensure easting and northing are numbers
          var easting =
            typeof data.easting === "number"
              ? data.easting
              : parseFloat(data.easting);
          var northing =
            typeof data.northing === "number"
              ? data.northing
              : parseFloat(data.northing);
          var zone = data.zone || "";

          if (isNaN(easting) || isNaN(northing)) {
            return '<div class="result-item"><span class="result-label">Error:</span><span class="result-value">Invalid UTM data received</span></div>';
          }

          html =
            '<div class="result-item">' +
            '<span class="result-label">Zone:</span>' +
            '<span class="result-value">' +
            escapeHtml(String(zone)) +
            "</span>" +
            "</div>";
          html += createResultItem(
            "Easting",
            easting.toFixed(3) + " m",
            easting.toFixed(3)
          );
          html += createResultItem(
            "Northing",
            northing.toFixed(3) + " m",
            northing.toFixed(3)
          );
        }

        return html;
      }

      // --- COPY TO CLIPBOARD ---
      function copyToClipboard(text, button) {
        // Store original HTML if not already stored
        if (!button.hasAttribute("data-original-html")) {
          button.setAttribute("data-original-html", button.innerHTML);
        }
        var originalHTML = button.getAttribute("data-original-html");

        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(text)
            .then(function () {
              updateCopyButton(button, originalHTML);
            })
            .catch(function (err) {
              // Fallback to older method
              fallbackCopyToClipboard(text, button, originalHTML);
            });
        } else {
          // Fallback for older browsers or non-HTTPS
          fallbackCopyToClipboard(text, button, originalHTML);
        }
      }

      // Fallback copy method for older browsers
      function fallbackCopyToClipboard(text, button, originalHTML) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          var successful = document.execCommand("copy");
          if (successful) {
            updateCopyButton(button, originalHTML);
          } else {
            alert("Failed to copy. Please copy manually: " + text);
          }
        } catch (err) {
          alert("Failed to copy. Please copy manually: " + text);
        } finally {
          document.body.removeChild(textArea);
        }
      }

      // --- MAP UPDATE ---
      function updateMap(lat, lon, popupText) {
        if (!map) return;
        lat = parseFloat(lat);
        lon = parseFloat(lon);
        if (isNaN(lat) || isNaN(lon)) return;

        // Validate coordinates are within reasonable bounds
        if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
          console.warn("Coordinates out of bounds:", lat, lon);
          return;
        }

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon], {
          icon: L.icon({
            iconUrl: "https://unpkg.com/leaflet/dist/images/marker-icon.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
          }),
        }).addTo(map);
        marker.bindPopup(popupText).openPopup();
        map.flyTo([lat, lon], 17, { animate: true, duration: 1.5 });
      }

      // --- GPS LOGIC ---
      function locateMe() {
        if (!navigator.geolocation) {
          showResult(
            "res_wgs",
            formatErrorMessage("Geolocation is not supported by your browser."),
            true
          );
          return;
        }

        var btn = document.getElementById("locate_btn");
        var originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Locating...';

        navigator.geolocation.getCurrentPosition(
          function (pos) {
            btn.disabled = false;
            btn.innerHTML = originalText;

            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const acc = pos.coords.accuracy;

            document.getElementById("wgs_lat").value = lat.toFixed(7);
            document.getElementById("wgs_lon").value = lon.toFixed(7);
            clearAllErrors();

            if (map) {
              updateMap(
                lat,
                lon,
                "<b>Your GPS Location</b><br>Accuracy: ±" +
                  Math.round(acc) +
                  "m"
              );

              if (accuracyCircle) map.removeLayer(accuracyCircle);
              accuracyCircle = L.circle([lat, lon], {
                color: "#136AEC",
                fillColor: "#136AEC",
                fillOpacity: 0.15,
                radius: acc,
              }).addTo(map);
              map.fitBounds(accuracyCircle.getBounds());
            }
          },
          function (err) {
            btn.disabled = false;
            btn.innerHTML = originalText;
            var errorMsg = "GPS Error: ";
            switch (err.code) {
              case err.PERMISSION_DENIED:
                errorMsg +=
                  "Location access denied. Please enable location permissions.";
                break;
              case err.POSITION_UNAVAILABLE:
                errorMsg += "Location information unavailable.";
                break;
              case err.TIMEOUT:
                errorMsg += "Location request timed out.";
                break;
              default:
                errorMsg += err.message;
            }
            showResult("res_wgs", formatErrorMessage(errorMsg), true);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      // --- CONVERSION LOGIC ---
      function convert(type) {
        clearAllErrors();
        var data = { type: type };
        var isValid = true;
        var buttonId = "";

        // Gather and validate inputs
        if (type.startsWith("wgs")) {
          data.lat = document.getElementById("wgs_lat").value.trim();
          data.lon = document.getElementById("wgs_lon").value.trim();

          var latVal = validateCoordinate(data.lat, true);
          var lonVal = validateCoordinate(data.lon, false);

          if (!latVal.valid) {
            showError("wgs_lat", "wgs_lat_error", latVal.error);
            isValid = false;
          }
          if (!lonVal.valid) {
            showError("wgs_lon", "wgs_lon_error", lonVal.error);
            isValid = false;
          }

          buttonId =
            type === "wgs_to_minna" ? "btn_wgs_to_minna" : "btn_wgs_to_utm";
        } else if (type.includes("minna") && !type.includes("utm")) {
          var minnaVal = validateMinnaCoordinates(
            "minna_lat",
            "minna_lon",
            "minna_lat_error",
            "minna_lon_error"
          );
          if (!minnaVal.valid) {
            isValid = false;
          } else {
            data.lat = minnaVal.lat;
            data.lon = minnaVal.lon;
          }
          buttonId = "btn_minna_to_wgs";
        } else if (type === "minna_to_utm") {
          var minnaVal = validateMinnaCoordinates(
            "minna_lat",
            "minna_lon",
            "minna_lat_error",
            "minna_lon_error"
          );
          if (!minnaVal.valid) {
            isValid = false;
          } else {
            data.lat = minnaVal.lat;
            data.lon = minnaVal.lon;
          }
          buttonId = "btn_minna_to_utm";
        } else if (type === "utm_to_wgs") {
          data.easting = document.getElementById("utm_e").value.trim();
          data.northing = document.getElementById("utm_n").value.trim();
          data.zone = document.getElementById("utm_z").value;

          if (!data.zone) {
            showError("utm_z", "utm_z_error", "Please select a UTM zone");
            isValid = false;
          }

          var utmVal = validateUTM(data.easting, data.northing);
          if (!utmVal.valid) {
            showError("utm_e", "utm_e_error", utmVal.error);
            showError("utm_n", "utm_n_error", utmVal.error);
            isValid = false;
          }

          buttonId = "btn_utm_to_wgs";
        }

        if (!isValid) {
          return;
        }

        // Set loading state
        setLoading(buttonId, true);

        // Send to Backend
        fetch("/convert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("Network response was not ok");
            }
            return res.json();
          })
          .then((res) => {
            setLoading(buttonId, false);

            var resultId = getResultId(type);

            if (!res.success) {
              showResult(
                resultId,
                formatErrorMessage(res.error || "Unknown error occurred"),
                true
              );
              return;
            }

            // Display results
            var html = formatResult(res, type);
            showResult(resultId, html, false);

            // Update map
            if (type === "wgs_to_minna" || type === "wgs_to_utm") {
              var lat = parseCoordinateString(data.lat);
              var lon = parseCoordinateString(data.lon);
              if (
                !isNaN(lat) &&
                !isNaN(lon) &&
                lat >= -90 &&
                lat <= 90 &&
                lon >= -180 &&
                lon <= 180
              ) {
                updateMap(
                  lat,
                  lon,
                  "Input WGS84<br>Lat: " +
                    lat.toFixed(6) +
                    "<br>Lon: " +
                    lon.toFixed(6)
                );
              }
            } else if (type === "minna_to_wgs" || type === "utm_to_wgs") {
              var resLat =
                typeof res.lat === "number" ? res.lat : parseFloat(res.lat);
              var resLon =
                typeof res.lon === "number" ? res.lon : parseFloat(res.lon);
              if (!isNaN(resLat) && !isNaN(resLon)) {
                updateMap(
                  resLat,
                  resLon,
                  "Converted WGS84<br>Lat: " +
                    resLat.toFixed(6) +
                    "<br>Lon: " +
                    resLon.toFixed(6)
                );
              }
            } else if (type === "minna_to_utm") {
              var mapLat =
                typeof res.map_lat === "number"
                  ? res.map_lat
                  : parseFloat(res.map_lat);
              var mapLon =
                typeof res.map_lon === "number"
                  ? res.map_lon
                  : parseFloat(res.map_lon);
              if (
                !isNaN(mapLat) &&
                !isNaN(mapLon) &&
                res.zone &&
                res.easting &&
                res.northing
              ) {
                updateMap(
                  mapLat,
                  mapLon,
                  "Converted Location<br>Zone: " +
                    res.zone +
                    "<br>E: " +
                    res.easting +
                    "m<br>N: " +
                    res.northing +
                    "m"
                );
              }
            }
          })
          .catch((err) => {
            setLoading(buttonId, false);
            console.error("Conversion error:", err);
            showResult(
              getResultId(type),
              formatErrorMessage(
                "Network error. Please check your connection and try again."
              ),
              true
            );
          });
      }

      // Add keyboard support for Enter key
      document.addEventListener("DOMContentLoaded", function () {
        var inputs = document.querySelectorAll("input");
        inputs.forEach(function (input) {
          input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              var card = input.closest(".card");
              var firstButton = card.querySelector(
                "button:not(.clear-btn):not(.locate-btn)"
              );
              if (firstButton) {
                firstButton.click();
              }
            }
          });
        });
      });
    </script>
  </body>
</html>
